name: Unit and integration tests (On-Prem)

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  clean:
    name: Clean temporary files
    runs-on: [self-hosted, hpu]
    steps:
      - name: Delete cache
        run: |
          sudo rm -rf /opt/github-actions-runner/_work/_temp/*
          echo HERE
          ls -al /opt/github-actions-runner/_work/_temp
  do-the-job:
    strategy:
      fail-fast: false
    name: Run tests
    runs-on: [self-hosted, hpu]
    container:
      image: vault.habana.ai/gaudi-docker/1.5.0/ubuntu20.04/habanalabs/pytorch-installer-1.11.0:1.5.0-610
      env:
        HABANA_VISIBLE_DEVICES: all
        OMPI_MCA_btl_vader_single_copy_mechanism: none
      options: --cap-add=sys_nice --runtime=habana
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Run tests
        run: |
          /bin/bash tests/ci/fast_tests.sh