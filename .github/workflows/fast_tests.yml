name: Unit and integration tests (On-Prem)

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  do-the-job:
    strategy:
      fail-fast: false
    name: Run tests
    runs-on: [self-hosted, hpu]
    steps:
      - name: 'Cleanup build folder'
        run: |
          ls -la ./
          sudo rm -rf ./* || true
          sudo rm -rf ./.??* || true
          ls -la ./
      - name: Checkout
        uses: actions/checkout@v2
      - name: Pull image
        run: |
          docker pull vault.habana.ai/gaudi-docker/1.5.0/ubuntu20.04/habanalabs/pytorch-installer-1.11.0:1.5.0-610
      - name: Run tests
        run: |
          docker run \
          -v $PWD:/root/workspace \
          --workdir=/root/workspace/optimum-habana \
          --runtime=habana \
          -e HABANA_VISIBLE_DEVICES=all \
          -e OMPI_MCA_btl_vader_single_copy_mechanism=none \
          --cap-add=sys_nice \
          --net=host \
          --ipc=host \
          vault.habana.ai/gaudi-docker/1.5.0/ubuntu20.04/habanalabs/pytorch-installer-1.11.0:1.5.0-610 \
          /bin/bash tests/ci/fast_tests.sh